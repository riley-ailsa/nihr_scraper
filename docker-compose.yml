version: '3.8'

services:
  # MongoDB Database (optional - use if you don't have external DB)
  mongodb:
    image: mongo:7
    container_name: nihr-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-dev_password}
      MONGO_INITDB_DATABASE: ailsa_grants
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - ./config/mongo_setup.js:/docker-entrypoint-initdb.d/mongo_setup.js
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # NIHR Scraper (one-time run)
  nihr-scraper:
    build: .
    container_name: nihr-scraper
    env_file: .env
    environment:
      # Override MONGO_URI to use docker mongodb
      MONGO_URI: mongodb://${MONGO_USER:-admin}:${MONGO_PASSWORD:-dev_password}@mongodb:27017/ailsa_grants?authSource=admin
    depends_on:
      mongodb:
        condition: service_healthy
    volumes:
      - ./outputs/logs:/app/outputs/logs
      - ./data/urls/nihr_urls.txt:/app/data/urls/nihr_urls.txt
    command: python3 run_ingestion.py
    restart: "no"

  # NIHR Scraper (cron mode - scheduled runs)
  nihr-scraper-cron:
    build: .
    container_name: nihr-scraper-cron
    env_file: .env
    environment:
      MONGO_URI: mongodb://${MONGO_USER:-admin}:${MONGO_PASSWORD:-dev_password}@mongodb:27017/ailsa_grants?authSource=admin
      CRON_SCHEDULE: "0 2 * * 2,5"  # Tuesday & Friday at 2 AM
    depends_on:
      mongodb:
        condition: service_healthy
    volumes:
      - ./outputs/logs:/app/outputs/logs
      - ./data/urls/nihr_urls.txt:/app/data/urls/nihr_urls.txt
    command: ./scripts/docker_entrypoint.sh cron
    restart: unless-stopped

volumes:
  mongodb_data:
    driver: local

networks:
  default:
    name: nihr-network
